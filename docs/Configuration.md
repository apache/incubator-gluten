<!-- DO NOT MODIFY THIS FILE DIRECTLY, IT IS AUTO-GENERATED BY [org.apache.gluten.config.AllGlutenConfiguration] -->

---

layout: page
title: Configuration
nav_order: 3
------------

# Spark Configurations for Gluten Plugin

There are many configurations could impact the Gluten Plugin performance and can be fine-tuned in Spark.
You can add these configurations into spark-defaults.conf to enable or disable the setting.

## Gluten configurations

|                                Key                                 |      Default      |                                                                                                                                                                                                                                                                                                                                                                                          Meaning                                                                                                                                                                                                                                                                                                                                                                                           |
|--------------------------------------------------------------------|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| spark.gluten.enabled                                               | true              | Whether to enable gluten. Default value is true. Just an experimental property. Recommend to enable/disable Gluten through the setting for spark.plugins.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.expression.blacklist                                  | &lt;undefined&gt; | A black list of expression to skip transform, multiple values separated by commas.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.memory.backtrace.allocation                           | false             | Print backtrace information for large memory allocations. This helps debugging when Spark OOM happens due to large acquire requests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.memory.conservative.task.offHeap.size.in.bytes        | 0                 | Must provide default value since non-execution operations (e.g. org.apache.spark.sql.Dataset#summary) doesn't propagate configurations using org.apache.spark.sql.execution.SQLExecution#withSQLConfPropagated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.memory.dynamic.offHeap.sizing.enabled                 | false             | Experimental: When set to true, the offheap config (spark.memory.offHeap.size) will be ignored and instead we will consider onheap and offheap memory in combination, both counting towards the executor memory config (spark.executor.memory). We will make use of JVM APIs to determine how much onheap memory is use, alongside tracking offheap allocations made by Gluten. We will then proceed to enforcing a total memory quota, calculated by the sum of what memory is committed and in use in the Java heap. Since the calculation of the total quota happens as offheap allocation happens and not as JVM heap memory is allocated, it is possible that we can oversubscribe memory. Additionally, note that this change is experimental and may have performance implications. |
| spark.gluten.memory.dynamic.offHeap.sizing.memory.fraction         | 0.6               | Experimental: Determines the memory fraction used to determine the total memory available for offheap and onheap allocations when the dynamic offheap sizing feature is enabled. The default is set to match spark.executor.memoryFraction.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| spark.gluten.memory.isolation                                      | false             | Enable isolated memory mode. If true, Gluten controls the maximum off-heap memory can be used by each task to X, X = executor memory / max task slots. It's recommended to set true if Gluten serves concurrent queries within a single session, since not all memory Gluten allocated is guaranteed to be spillable. In the case, the feature should be enabled to avoid OOM.                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.memory.offHeap.size.in.bytes                          | 0                 | Must provide default value since non-execution operations (e.g. org.apache.spark.sql.Dataset#summary) doesn't propagate configurations using org.apache.spark.sql.execution.SQLExecution#withSQLConfPropagated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.memory.overAcquiredMemoryRatio                        | 0.3               | If larger than 0, Velox backend will try over-acquire this ratio of the total allocated memory as backup to avoid OOM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| spark.gluten.memory.reservationBlockSize                           | 8MB               | Block size of native reservation listener reserve memory from Spark.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.memory.task.offHeap.size.in.bytes                     | 0                 | Must provide default value since non-execution operations (e.g. org.apache.spark.sql.Dataset#summary) doesn't propagate configurations using org.apache.spark.sql.execution.SQLExecution#withSQLConfPropagated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.memoryOverhead.size.in.bytes                          | 0                 | Must provide default value since non-execution operations (e.g. org.apache.spark.sql.Dataset#summary) doesn't propagate configurations using org.apache.spark.sql.execution.SQLExecution#withSQLConfPropagated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.numTaskSlotsPerExecutor                               | -1                | Must provide default value since non-execution operations (e.g. org.apache.spark.sql.Dataset#summary) doesn't propagate configurations using org.apache.spark.sql.execution.SQLExecution#withSQLConfPropagated                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.ras.costModel                                         | legacy            | Experimental: The class name of user-defined cost model that will be used by RAS. If not specified, a legacy built-in cost model that exhaustively offloads computations will be used.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| spark.gluten.ras.enabled                                           | false             | Experimental: Enables RAS (relational algebra selector) during physical planning to generate more efficient query plan. Note, this feature is still in development and may not bring performance profits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.ras.rough2.r2c.cost                                   | 100               | Experimental: Cost of RowToVeloxColumnarExec in RAS rough2 model                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.ras.rough2.sizeBytesThreshold                         | 1073741824        | Experimental: Threshold of the byte size consumed by sparkPlan, coefficient used to calculate cost in RAS rough2 model                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| spark.gluten.ras.rough2.vanilla.cost                               | 20                | Experimental: Cost of vanilla spark operater in RAS rough model                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.saveDir                                                                  ||
| spark.gluten.shuffleWriter.bufferSize                              | &lt;undefined&gt; |
| spark.gluten.soft-affinity.logLevel                                | DEBUG             |
| spark.gluten.sql.adaptive.costEvaluator.enabled                    | true              | If true, use org.apache.spark.sql.execution.adaptive.GlutenCostEvaluator as custom cost evaluator class, else follow the configuration spark.sql.adaptive.customCostEvaluatorClass.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.benchmark_task.partitionId                                           ||
| spark.gluten.sql.benchmark_task.stageId                            | -1                |
| spark.gluten.sql.benchmark_task.taskId                                                ||
| spark.gluten.sql.broadcastNestedLoopJoinTransformerEnabled         | true              | Config to enable BroadcastNestedLoopJoinExecTransformer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| spark.gluten.sql.cacheWholeStageTransformerContext                 | false             | When true, `WholeStageTransformer` will cache the `WholeStageTransformerContext` when executing. It is used to get substrait plan node and native plan string.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.sql.cartesianProductTransformerEnabled                | true              | Config to enable CartesianProductExecTransformer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.arrowUdf                                 | true              | Enable or disable columnar arrow udf.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| spark.gluten.sql.columnar.batchscan                                | true              | Enable or disable columnar batchscan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| spark.gluten.sql.columnar.broadcastExchange                        | true              | Enable or disable columnar broadcastExchange.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| spark.gluten.sql.columnar.broadcastJoin                            | true              | Enable or disable columnar broadcastJoin.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.cast.avg                                 | true              |
| spark.gluten.sql.columnar.coalesce                                 | true              | Enable or disable columnar coalesce.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.columnar.columnarToRow                            | true              | Enable or disable columnar columnarToRow.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.coreRange                                | &lt;undefined&gt; |
| spark.gluten.sql.columnar.enableNestedColumnPruningInHiveTableScan | true              | Enable or disable nested column pruning in hivetablescan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.enableVanillaVectorizedReaders           | true              | Enable or disable vanilla vectorized scan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| spark.gluten.sql.columnar.expand                                   | true              | Enable or disable columnar expand.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.extended.columnar.post.rules                                || A comma-separated list of classes for the extended columnar post rules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.extended.columnar.transform.rules                           || A comma-separated list of classes for the extended columnar transform rules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| spark.gluten.sql.columnar.extended.expressions.transformer                            || A class for the extended expressions transformer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.fallback.expressions.threshold           | 50                | Fall back filter/project if number of nested expressions reaches this threshold, considering Spark codegen can bring better performance for such case.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| spark.gluten.sql.columnar.fallback.ignoreRowToColumnar             | true              | When true, the fallback policy ignores the RowToColumnar when counting fallback number.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.fallback.preferColumnar                  | true              | When true, the fallback policy prefers to use Gluten plan rather than vanilla Spark plan if the both of them contains ColumnarToRow and the vanilla Spark plan ColumnarToRow number is not smaller than Gluten plan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.columnar.fallbackReporter                         | true              | When true, enable fallback reporter rule to print fallback reason                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.filescan                                 | true              | Enable or disable columnar filescan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.columnar.filter                                   | true              | Enable or disable columnar filter.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.force.hashagg                            | true              | Whether to force to use gluten's hash agg for replacing vanilla spark's sort agg.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.forceShuffledHashJoin                    | true              |
| spark.gluten.sql.columnar.generate                                 | true              |
| spark.gluten.sql.columnar.hashagg                                  | true              | Enable or disable columnar hashagg.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.columnar.hivetablescan                            | true              | Enable or disable columnar hivetablescan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.limit                                    | true              |
| spark.gluten.sql.columnar.logicalJoinOptimizationLevel             | 12                | Fallback to row operators if there are several continuous joins.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.sql.columnar.maxBatchSize                             | 4096              |
| spark.gluten.sql.columnar.numaBinding                              | false             |
| spark.gluten.sql.columnar.oneRowRelation                           | true              | Enable or disable columnar `OneRowRelation`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| spark.gluten.sql.columnar.parquet.write.blockSize                  | 128MB             |
| spark.gluten.sql.columnar.partial.project                          | true              | Break up one project node into 2 phases when some of the expressions are non offload-able. Phase one is a regular offloaded project transformer that evaluates the offload-able expressions in native, phase two preserves the output from phase one and evaluates the remaining non-offload-able expressions using vanilla Spark projections                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| spark.gluten.sql.columnar.physicalJoinOptimizationLevel            | 12                | Fallback to row operators if there are several continuous joins.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.sql.columnar.physicalJoinOptimizeEnable               | false             | Enable or disable columnar physicalJoinOptimize.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.sql.columnar.preferColumnar                           | true              | Prefer to use columnar operators if set to true.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.sql.columnar.preferStreamingAggregate                 | true              | Velox backend supports `StreamingAggregate`. `StreamingAggregate` uses the less memory as it does not need to hold all groups in memory, so it could avoid spill. When true and the child output ordering satisfies the grouping key then Gluten will choose `StreamingAggregate` as the native operator.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.project                                  | true              | Enable or disable columnar project.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.columnar.project.collapse                         | true              | Combines two columnar project operators into one and perform alias substitution                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.query.fallback.threshold                 | -1                | The threshold for whether query will fall back by counting the number of ColumnarToRow & vanilla leaf node.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| spark.gluten.sql.columnar.scanOnly                                 | false             | When enabled, only scan and the filter after scan will be offloaded to native.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.sql.columnar.shuffle                                  | true              | Enable or disable columnar shuffle.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.columnar.shuffle.celeborn.fallback.enabled        | true              | If enabled, fall back to ColumnarShuffleManager when celeborn service is unavailable.Otherwise, throw an exception.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.columnar.shuffle.codec                            | &lt;undefined&gt; | By default, the supported codecs are lz4 and zstd. When spark.gluten.sql.columnar.shuffle.codecBackend=qat,the supported codecs are gzip and zstd. When spark.gluten.sql.columnar.shuffle.codecBackend=iaa,the supported codec is gzip.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.shuffle.codecBackend                     | &lt;undefined&gt; |
| spark.gluten.sql.columnar.shuffle.compression.threshold            | 100               | If number of rows in a batch falls below this threshold, will copy all buffers into one buffer to compress.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| spark.gluten.sql.columnar.shuffle.compressionMode                  | buffer            | buffer means compress each buffer to pre allocated big buffer,rowvector means to copy the buffers to a big buffer, and then compress the buffer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.shuffle.merge.threshold                  | 0.25              |
| spark.gluten.sql.columnar.shuffle.readerBufferSize                 | 1MB               | Buffer size in bytes for shuffle reader reading input stream from local or remote.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.shuffle.realloc.threshold                | 0.25              |
| spark.gluten.sql.columnar.shuffle.sort.columns.threshold           | 100000            | The threshold to determine whether to use sort-based columnar shuffle. Sort-based shuffle will be used if the number of columns is greater than this threshold.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.shuffle.sort.partitions.threshold        | 100000            | The threshold to determine whether to use sort-based columnar shuffle. Sort-based shuffle will be used if the number of partitions is greater than this threshold.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.shuffledHashJoin                         | true              | Enable or disable columnar shuffledHashJoin.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| spark.gluten.sql.columnar.shuffledHashJoin.optimizeBuildSide       | true              | Whether to allow Gluten to choose an optimal build side for shuffled hash join.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.sort                                     | true              | Enable or disable columnar sort.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.sql.columnar.sortMergeJoin                            | true              | Enable or disable columnar sortMergeJoin. This should be set with preferSortMergeJoin=false.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| spark.gluten.sql.columnar.tableCache                               | false             | Enable or disable columnar table cache.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.takeOrderedAndProject                    | true              |
| spark.gluten.sql.columnar.tmp_dir                                  | &lt;undefined&gt; | A folder to store the codegen files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.columnar.union                                    | true              | Enable or disable columnar union.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.wholeStage.fallback.threshold            | -1                | The threshold for whether whole stage will fall back in AQE supported case by counting the number of ColumnarToRow & vanilla leaf node.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.window                                   | true              | Enable or disable columnar window.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.window.group.limit                       | true              | Enable or disable columnar window group limit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.sql.columnarSampleEnabled                             | false             | Disable or enable columnar sample.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnarToRowMemoryThreshold                      | 64MB              |
| spark.gluten.sql.commonSubexpressionEliminate                      | true              | Eliminate common subexpressions in logical plan to avoid multiple evaluation of the sameexpression, may improve performance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| spark.gluten.sql.countDistinctWithoutExpand                        | false             | Convert Count Distinct to a UDAF called count_distinct to prevent SparkPlanner converting it to Expand+Count. WARNING: When enabled, count distinct queries will fail to fallback!!!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.debug                                             | false             |
| spark.gluten.sql.debug.keepJniWorkspace                            | false             |
| spark.gluten.sql.debug.keepJniWorkspaceDir                         | /tmp              |
| spark.gluten.sql.enable.native.validation                          | true              | This is tmp config to specify whether to enable the native validation based on Substrait plan. After the validations in all backends are correctly implemented, this config should be removed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| spark.gluten.sql.extendedGeneratorNestedColumnAliasing             | true              | Do nested column aliasing for Project(Filter(Generator))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| spark.gluten.sql.fallbackRegexpExpressions                         | false             | If true, fall back all regexp expressions. There are a few incompatible cases between RE2 (used by native engine) and java.util.regex (used by Spark). User should enable this property if their incompatibility is intolerable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| spark.gluten.sql.injectNativePlanStringToExplain                   | false             | When true, Gluten will inject native plan tree to explain string inside `WholeStageTransformerContext`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.mergeTwoPhasesAggregate.enabled                   | true              | Whether to merge two phases aggregate if there are no other operators between them.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.native.arrow.reader.enabled                       | false             | This is config to specify whether to enable the native columnar csv reader                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| spark.gluten.sql.native.bloomFilter                                | true              |
| spark.gluten.sql.native.hive.writer.enabled                        | true              | This is config to specify whether to enable the native columnar writer for HiveFileFormat. Currently only supports HiveFileFormat with Parquet as the output file type.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.native.hyperLogLog.Aggregate                      | true              |
| spark.gluten.sql.native.parquet.write.blockRows                    | 100000000         |
| spark.gluten.sql.native.writeColumnMetadataExclusionList           | comment           | Native write files does not support column metadata. Metadata in list would be removed to support native write files. Multiple values separated by commas.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| spark.gluten.sql.native.writer.enabled                             | &lt;undefined&gt; | This is config to specify whether to enable the native columnar parquet/orc writer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.orc.charType.scan.fallback.enabled                | true              | Force fallback for orc char type scan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| spark.gluten.sql.parquet.maxmin.index                              | false             | Enable row group max min index for parquet file scan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.parquet.timestampType.scan.fallback.enabled       | false             | Force fallback for parquet timestamp type scan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.removeNativeWriteFilesSortAndProject              | true              | When true, Gluten will remove the vanilla Spark V1Writes added sort and project for velox backend.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.rewrite.dateTimestampComparison                   | true              | Rewrite the comparision between date and timestamp to timestamp comparison.For example `from_unixtime(ts) > date` will be rewritten to `ts > to_unixtime(date)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.scan.fileSchemeValidation.enabled                 | true              | When true, enable file path scheme validation for scan. Validation will fail if file scheme is not supported by registered file systems, which will cause scan  operator fall back.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| spark.gluten.sql.substrait.plan.logLevel                           | DEBUG             |
| spark.gluten.sql.text.input.empty.as.default                       | false             | treat empty fields in CSV input as default values.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.text.input.max.block.size                         | 8KB               | the max block size for text input rows                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| spark.gluten.sql.transform.logLevel                                | DEBUG             |
| spark.gluten.sql.ut.statistic                                      | false             |
| spark.gluten.sql.validation.logLevel                               | WARN              |
| spark.gluten.sql.validation.printStackOnFailure                    | false             |
| spark.gluten.storage.hdfsViewfs.enabled                            | false             | If enabled, gluten will convert the viewfs path to hdfs path in scala side                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

## Gluten Velox backend configurations

The following configurations are related to Velox settings.

|                                       Key                                        |      Default      |                                                                                                                                                   Meaning                                                                                                                                                   |
|----------------------------------------------------------------------------------|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| spark.gluten.sql.columnar.backend.velox.IOThreads                                | &lt;undefined&gt; | The Size of the IO thread pool in the Connector. This thread pool is used for split preloading and DirectBufferedInput. By default, the value is the same as the maximum task slots per Spark executor.                                                                                                     |
| spark.gluten.sql.columnar.backend.velox.SplitPreloadPerDriver                    | 2                 | The split preload per task                                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.backend.velox.abandonPartialAggregationMinPct          | 90                | If partial aggregation aggregationPct greater than this value, partial aggregation may be early abandoned. Note: this option only works when flushable partial aggregation is enabled. Ignored when spark.gluten.sql.columnar.backend.velox.flushablePartialAggregation=false.                              |
| spark.gluten.sql.columnar.backend.velox.abandonPartialAggregationMinRows         | 100000            | If partial aggregation input rows number greater than this value,  partial aggregation may be early abandoned. Note: this option only works when flushable partial aggregation is enabled. Ignored when spark.gluten.sql.columnar.backend.velox.flushablePartialAggregation=false.                          |
| spark.gluten.sql.columnar.backend.velox.asyncTimeoutOnTaskStopping               | 30000ms           | Timeout for asynchronous execution when task is being stopped in Velox backend. It's recommended to set to a number larger than network connection timeout that the possible aysnc tasks are relying on.                                                                                                    |
| spark.gluten.sql.columnar.backend.velox.bloomFilter.expectedNumItems             | 1000000           | The default number of expected items for the velox bloomfilter: 'spark.bloom_filter.expected_num_items'                                                                                                                                                                                                     |
| spark.gluten.sql.columnar.backend.velox.bloomFilter.maxNumBits                   | 4194304           | The max number of bits to use for the velox bloom filter: 'spark.bloom_filter.max_num_bits'                                                                                                                                                                                                                 |
| spark.gluten.sql.columnar.backend.velox.bloomFilter.numBits                      | 8388608           | The default number of bits to use for the velox bloom filter: 'spark.bloom_filter.num_bits'                                                                                                                                                                                                                 |
| spark.gluten.sql.columnar.backend.velox.cacheEnabled                             | false             | Enable Velox cache, default off                                                                                                                                                                                                                                                                             |
| spark.gluten.sql.columnar.backend.velox.cachePrefetchMinPct                      | 0                 | Set prefetch cache min pct for velox file scan                                                                                                                                                                                                                                                              |
| spark.gluten.sql.columnar.backend.velox.directorySizeGuess                       | 32KB              | Set the directory size guess for velox file scan                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.backend.velox.enableSystemExceptionStacktrace          | true              | Enable the stacktrace for system type of VeloxException                                                                                                                                                                                                                                                     |
| spark.gluten.sql.columnar.backend.velox.enableUserExceptionStacktrace            | true              | Enable the stacktrace for user type of VeloxException                                                                                                                                                                                                                                                       |
| spark.gluten.sql.columnar.backend.velox.fileHandleCacheEnabled                   | false             | Disables caching if false. File handle cache should be disabled if files are mutable, i.e. file content may change while file path stays the same.                                                                                                                                                          |
| spark.gluten.sql.columnar.backend.velox.filePreloadThreshold                     | 1MB               | Set the file preload threshold for velox file scan                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.backend.velox.flushablePartialAggregation              | true              | Enable flushable aggregation. If true, Gluten will try converting regular aggregation into Velox's flushable aggregation when applicable. A flushable aggregation could emit intermediate result at anytime when memory is full / data reduction ratio is low.                                              |
| spark.gluten.sql.columnar.backend.velox.glogSeverityLevel                        | 1                 | Set glog severity level in Velox backend, same as FLAGS_minloglevel.                                                                                                                                                                                                                                        |
| spark.gluten.sql.columnar.backend.velox.glogVerboseLevel                         | 0                 | Set glog verbose level in Velox backend, same as FLAGS_v.                                                                                                                                                                                                                                                   |
| spark.gluten.sql.columnar.backend.velox.loadQuantum                              | 256MB             | Set the load quantum for velox file scan                                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.backend.velox.maxCoalescedBytes                        | 64MB              | Set the max coalesced bytes for velox file scan                                                                                                                                                                                                                                                             |
| spark.gluten.sql.columnar.backend.velox.maxCoalescedDistanceBytes                | 1MB               | Set the max coalesced distance bytes for velox file scan                                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.backend.velox.maxExtendedPartialAggregationMemoryRatio | 0.15              | Set the max extended memory of partial aggregation as maxExtendedPartialAggregationMemoryRatio of offheap size. Note: this option only works when flushable partial aggregation is enabled. Ignored when spark.gluten.sql.columnar.backend.velox.flushablePartialAggregation=false.                         |
| spark.gluten.sql.columnar.backend.velox.maxPartialAggregationMemoryRatio         | 0.1               | Set the max memory of partial aggregation as maxPartialAggregationMemoryRatio of offheap size. Note: this option only works when flushable partial aggregation is enabled. Ignored when spark.gluten.sql.columnar.backend.velox.flushablePartialAggregation=false.                                          |
| spark.gluten.sql.columnar.backend.velox.maxPartitionsPerWritersSession           | 10000             | Maximum number of partitions per a single table writer instance.                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.backend.velox.maxSpillBytes                            | 100G              | The maximum file size of a query                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.backend.velox.maxSpillFileSize                         | 1GB               | The maximum size of a single spill file created                                                                                                                                                                                                                                                             |
| spark.gluten.sql.columnar.backend.velox.maxSpillLevel                            | 4                 | The max allowed spilling level with zero being the initial spilling level                                                                                                                                                                                                                                   |
| spark.gluten.sql.columnar.backend.velox.maxSpillRunRows                          | 3M                | The maximum row size of a single spill run                                                                                                                                                                                                                                                                  |
| spark.gluten.sql.columnar.backend.velox.memCacheSize                             | 1GB               | The memory cache size                                                                                                                                                                                                                                                                                       |
| spark.gluten.sql.columnar.backend.velox.memInitCapacity                          | 8MB               | The initial memory capacity to reserve for a newly created Velox query memory pool.                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.backend.velox.memoryUseHugePages                       | false             | Use explicit huge pages for Velox memory allocation.                                                                                                                                                                                                                                                        |
| spark.gluten.sql.columnar.backend.velox.orc.scan.enabled                         | true              | Enable velox orc scan. If disabled, vanilla spark orc scan will be used.                                                                                                                                                                                                                                    |
| spark.gluten.sql.columnar.backend.velox.prefetchRowGroups                        | 1                 | Set the prefetch row groups for velox file scan                                                                                                                                                                                                                                                             |
| spark.gluten.sql.columnar.backend.velox.reclaimMaxWaitMs                         | 3600000ms         | The max time in ms to wait for memory reclaim.                                                                                                                                                                                                                                                              |
| spark.gluten.sql.columnar.backend.velox.resizeBatches.shuffleInput               | true              | If true, combine small columnar batches together before sending to shuffle. The default minimum output batch size is equal to 0.8 * spark.gluten.sql.columnar.maxBatchSize                                                                                                                                  |
| spark.gluten.sql.columnar.backend.velox.resizeBatches.shuffleInput.minSize       | &lt;undefined&gt; | The minimum batch size for shuffle. If size of an input batch is smaller than the value, it will be combined with other batches before sending to shuffle. Only functions when spark.gluten.sql.columnar.backend.velox.resizeBatches.shuffleInput is set to true. Default value: 0.25 * <max batch size>    |
| spark.gluten.sql.columnar.backend.velox.showTaskMetricsWhenFinished              | false             | Show velox full task metrics when finished.                                                                                                                                                                                                                                                                 |
| spark.gluten.sql.columnar.backend.velox.spillFileSystem                          | local             | The filesystem used to store spill data. local: The local file system. heap-over-local: Write file to JVM heap if having extra heap space. Otherwise write to local file system.                                                                                                                            |
| spark.gluten.sql.columnar.backend.velox.spillStrategy                            | auto              | none: Disable spill on Velox backend; auto: Let Spark memory manager manage Velox's spilling                                                                                                                                                                                                                |
| spark.gluten.sql.columnar.backend.velox.spillWriteBufferSize                     | 4M                | The maximum write buffer size                                                                                                                                                                                                                                                                               |
| spark.gluten.sql.columnar.backend.velox.ssdCacheIOThreads                        | 1                 | The IO threads for cache promoting                                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.backend.velox.ssdCachePath                             | /tmp              | The folder to store the cache files, better on SSD                                                                                                                                                                                                                                                          |
| spark.gluten.sql.columnar.backend.velox.ssdCacheShards                           | 1                 | The cache shards                                                                                                                                                                                                                                                                                            |
| spark.gluten.sql.columnar.backend.velox.ssdCacheSize                             | 1GB               | The SSD cache size, will do memory caching only if this value = 0                                                                                                                                                                                                                                           |
| spark.gluten.sql.columnar.backend.velox.ssdODirect                               | false             | The O_DIRECT flag for cache writing                                                                                                                                                                                                                                                                         |
| spark.gluten.sql.columnar.backend.velox.window.type                              | streaming         | Velox backend supports both SortWindow and StreamingWindow operators. The StreamingWindow operator skips the sorting step in the input but does not support spill. On the other hand, the SortWindow operator is responsible for sorting the input data within the Window operator and also supports spill. |
| spark.gluten.velox.awsSdkLogLevel                                                | FATAL             | Log granularity of AWS C++ SDK in velox.                                                                                                                                                                                                                                                                    |
| spark.gluten.velox.castFromVarcharAddTrimNode                                    | false             | If true, will add a trim node which has the same sementic as vanilla Spark to CAST-from-varchar.Otherwise, do nothing.                                                                                                                                                                                      |
| spark.gluten.velox.fs.s3a.connect.timeout                                        | 200s              | Timeout for AWS s3 connection.                                                                                                                                                                                                                                                                              |
| spark.gluten.velox.fs.s3a.retry.mode                                             | legacy            | Retry mode for AWS s3 connection error: legacy, standard and adaptive.                                                                                                                                                                                                                                      |

## Gluten CH backend configurations

The following configurations are related to CH settings.

|                             Key                             | Default |                                                                                Meaning                                                                                 |
|-------------------------------------------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| spark.gluten.sql.columnar.backend.ch.forceMemorySortShuffle | false   | Whether to force to use memory sort shuffle in CH backend.                                                                                                             |
| spark.gluten.sql.columnar.backend.ch.maxSortBufferSize      | 0       | The maximum size of sort shuffle buffer in CH backend.                                                                                                                 |
| spark.gluten.sql.columnar.backend.ch.rewrite.dateConversion | true    | Rewrite the conversion between date and string.For example `to_date(from_unixtime(unix_timestamp(stringType, 'yyyyMMdd')))` will be rewritten to `to_date(stringType)` |
| spark.gluten.sql.columnar.backend.ch.spillThreshold         | 0MB     | Shuffle spill threshold on ch backend                                                                                                                                  |

# Thread level gluten configuration

Additionally, you can control the configurations of gluten at thread level by local property.

|           Parameters           |                 Description                  | Recommend Setting |
|--------------------------------|----------------------------------------------|-------------------|
| gluten.enabledForCurrentThread | Control the usage of gluten at thread level. | true              |

Below is an example of developing an application using scala to set local properties.

```scala
// Before executing the query, set local properties.
sparkContext.setLocalProperty(key, value)
spark.sql("select * from demo_tables").show()
```

